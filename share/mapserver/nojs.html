<!DOCTYPE html>
<html lang="en">
<head>
  <title>Rising World Map Example</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

  <style>
    body {
      margin: 0;
      -moz-user-select: -moz-none;
      -khtml-user-select: none;
      -webkit-user-select: none;
      background-color: #000000;
    }
  </style>

  <script src="jquery.js"></script>
  <script src="jquery.gracefulWebSocket.js"></script>
  <script src="scenejs.js"></script>
<body>

<script>
var ws = $.gracefulWebSocket("ws://" + window.location.hostname + ":4288/");
var scene;
ws.onmessage = function (event) {
  var data = $.parseJSON(event.data);
  console.log(data);
};

function update_scene() {

  SceneJS.reset();

  $.getJSON( "data.json", function(data) {

    var cidx = {};
    var pos = [];
    var indices = [];
    var p = 0;

    $.each(data['Chunks'],function(i,c){
      var x = c[0];
      var y = c[1];
      var z = c[2];
      if (!cidx[x]) {
        cidx[x] = {};
      }
      if (!cidx[x][y]) {
        cidx[x][y] = {};
      }
      var cur = p++;
      cidx[x][y][z] = cur;
      pos.push(x);
      pos.push(y * 4);
      pos.push(z);
      if (z+1 in cidx[x][y]) {
        indices.push(cur,cidx[x][y][z+1]);
      }
      if (z-1 in cidx[x][y]) {
        indices.push(cur,cidx[x][y][z-1]);
      }
      if (cidx[x+1] && cidx[x+1][y]) {
        if (z in cidx[x+1][y]) {
          indices.push(cur,cidx[x+1][y][z]);
        }
      }
      if (cidx[x-1] && cidx[x-1][y]) {
        if (z in cidx[x-1][y]) {
          indices.push(cur,cidx[x-1][y][z]);
        }
      }
      if (cidx[x][y+1]) {
        if (z in cidx[x][y+1]) {
          indices.push(cur,cidx[x][y+1][z]);
        }
      }
      if (cidx[x][y-1]) {
        if (z in cidx[x][y-1]) {
          indices.push(cur,cidx[x][y-1][z]);
        }
      }
    });

    var widx = {};
    var wpos = [];
    var windices = [];
    var wp = 0;

    $.each(data['Worldchunks'],function(i,c){
      var x = c[0];
      var y = 0;
      var z = c[1];
      if (!widx[x]) {
        widx[x] = {};
      }
      if (!widx[x][y]) {
        widx[x][y] = {};
      }
      var cur = wp++;
      widx[x][y][z] = cur;
      wpos.push(x);
      wpos.push(y);
      wpos.push(z);
      if (z+1 in widx[x][y]) {
        windices.push(cur,widx[x][y][z+1]);
      }
      if (z-1 in widx[x][y]) {
        windices.push(cur,widx[x][y][z-1]);
      }
      if (widx[x+1] && widx[x+1][y]) {
        if (z in widx[x+1][y]) {
          windices.push(cur,widx[x+1][y][z]);
        }
      }
      if (widx[x-1] && widx[x-1][y]) {
        if (z in widx[x-1][y]) {
          windices.push(cur,widx[x-1][y][z]);
        }
      }
    });

    SceneJS.setConfigs({
      pluginPath: "scenejs"
    });

    scene = SceneJS.createScene({
      transparent: true,
      nodes: [{
        id: "cam",
        type: "cameras/pickFlyOrbit",
        //showCursor: true,
        yaw: 90,
        pitch: -45,
        zoom: 75,
        zoomSensitivity: 20.0,
        nodes: [{          
          type: "material",
          color: { r:1, g:0, b:0 },
          nodes: [{
            id: "chunks",
            type: "geometry",
            primitive: "lines",
            positions: pos,
            indices: indices
          }]
        },{
          type: "material",
          color: { r:0, g:1, b:0 },
          nodes: [{
            id: "Worldchunks",
            type: "geometry",
            primitive: "lines",
            positions: wpos,
            indices: windices
          }]        
        },{
                        type: "scale",
                        id: "__sphereSize",
                        x: 1,
                        y: 1,
                        z: 1,
                        nodes: [
                            {
                                type: "material",
                                color: { r: 0.4, g: 1.0, b: 0.4 },
                                specularColor: { r: 1.0, g: 1.0, b: 1.0 },
                                emit: 0.2,
                                nodes: [
                                    {
                                        type: "style",
                                        lineWidth: 2,
                                        nodes: [

                                            // Sphere primitive implemented by plugin at
                                            // http://scenejs.org/api/latest/plugins/node/geometry/sphere.js
                                            {
                                                type: "geometry/sphere",
                                                positions: { x: 1, y: 3, z: 5 }
                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    }]
      }]
    });


if (scene) {
    console.log("Scene defined");
    scene.getNode("cam",
    function(cam) {
          //cam.removeNodes();
     });
   };


  });
}

update_scene();
</script>
</body>
</html>
