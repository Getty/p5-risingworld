<!DOCTYPE html>
<html lang="en">
<head>
  <title>Rising World Map Example</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

  <style>
    body {
      margin: 0;
      -moz-user-select: -moz-none;
      -khtml-user-select: none;
      -webkit-user-select: none;
      background-color: #000000;
    }
  </style>

  <script src="jquery.js"></script>
  <script src="jquery.gracefulWebSocket.js"></script>
  <script src="scenejs.js"></script>
<body>

<script>
var ws = $.gracefulWebSocket("ws://" + window.location.hostname + ":4288/");
var scene;
var labelY = 0;
var players = {};
nextColor = 0;
var colors = [
              {r: 1.0, g: 1.0, b: 1.0}, //WHITE
              {r: 0.75, g: 0.75, b: 0.75}, //SILVER
          //    {r: 1.0, g: 0.0, b: 0.0}, //RED 
              {r: 1.0, g: 1.0, b: 0.0}, //YELLOW
          //    {r: 0.0, g: 1.0, b: 0.0}, //LIME
              {r: 0.0, g: 1.0, b: 1.0}, //AQUA
              {r: 0.0, g: 0.0, b: 1.0}, //BLUE
              {r: 1.0, g: 0.0, b: 1.0}, //FUCHSIA
              {r: 0.5, g: 0.0, b: 0.5} //PURPLE
             ];
var colorsHTML = [
    "#FFFFFF",
    "#C0C0C0",
    //"#FF0000",
    "#FFFF00",
    //"#00FF00",
    "#00FFFF",
    "#0000FF",
    "#FF00FF",
    "#800080"
  ];
  
function createLabel(text,color,posx,posy) {
            var text;
            var body = document.getElementsByTagName("body")[0];
            var div = document.createElement('div');

            var style = div.style;
            style.display = "none";
            style.position = "absolute";
            style["font-family"] = "Helvetica";
            style["font-size"] = "14px";
            style.padding = "5px";
            style.margin = "4px";
            style["padding-left"] = "12px";
            style["border"] = "1px solid #000055";
            style.color = "black";
            style.background = "#AAFFAA";
            style.opacity = "0.8";
            style["border-radius"] = "3px";
            style["z-index"] = 100000;
            style["-moz-border-radius"] = "3px";
            style["box-shadow"] = "3px 3px 3px #444444";
            style.left = "0";
            style.top = "0";
            style.height = "auto";
            style.width = "auto";
            div.innerHTML += 'Foo';
            body.appendChild(div);
 
                    style.left = "" + pos.x + "px";
                    style.top = "" + pos.y + "px";

         
                    text = t;
                    div.innerHTML = "<span>" + text + "</span>";

                
         
                  style.background=c;
    
  };
function createPlayerIfNotExists(data) {
  if (scene) {
  var sphereNode = scene.getNode(data.player.name + "_sphereTranslate");
          if (!sphereNode) {
            var color = colors[nextColor];
            var colorHTML = colorsHTML[nextColor];
            if (nextColor == colors.length) {
              nextColor = 0;
            } else {
              nextColor++;
            }
            players[data.player.name] = {
              type: "translate",
              id: data.player.name + "_sphereTranslate",
              x: 0,
              y: 0,
              z: 0,
              nodes: [
                {
                  type: "material",
                  color: color,
                  specularColor: { r: 1.0, g: 1.0, b: 1.0 },
                  nodes: [
                    {
                      type: "style",
                      lineWidth: 2,
                      nodes: [
                        {
                          type: "geometry/sphere",
                          id: data.player.name + "_sphere",
                          latitudeBands: 30, // Default
                          longitudeBands: 30, // Default
                          radius: 0.5, // Default
                          wire: false // Default
                        }
                      ]
                    }
                  ]
                }
              ]
          };
          scene.getNode("attachme", function(cam) {
            cam.addNode(players[data.player.name]);
          });
          createLabel(data.player.name,colorHTML,0,labelY);
          labelY = labelY + 5;
        }
       
  }
          
}


ws.onmessage = function (event) {
  var data = $.parseJSON(event.data);
  console.log(data);
  if (data.EventName == "PlayerEnterChunk") {
        console.log(data.newChunk.x);
        if (scene) {
          console.log("Scene defined");
          createPlayerIfNotExists(data);
          scene.getNode(data.player.name + "_sphereTranslate",
          function(newTranslate) {
            newTranslate.set({
              y: data.newChunk.y * 4,
              x: data.newChunk.x,
              z: data.newChunk.z
            });
            
          });
    };

} else if (data.EventName == "PlayerConnect") {
    createPlayerIfNotExists(data);
} else if (data.EventName == "PlayerDisconnect") {
  if (scene) {
    scene.getNode(data.player.name + "_sphereTranslate").destroy();
  }
}

};

function update_scene() {

  SceneJS.reset();

  $.getJSON( "data.json", function(data) {

    var cidx = {};
    var pos = [];
    var indices = [];
    var p = 0;

    $.each(data['Chunks'],function(i,c){
      var x = c[0];
      var y = c[1];
      var z = c[2];
      if (!cidx[x]) {
        cidx[x] = {};
      }
      if (!cidx[x][y]) {
        cidx[x][y] = {};
      }
      var cur = p++;
      cidx[x][y][z] = cur;
      pos.push(x);
      pos.push(y * 4);
      pos.push(z);
      if (z+1 in cidx[x][y]) {
        indices.push(cur,cidx[x][y][z+1]);
      }
      if (z-1 in cidx[x][y]) {
        indices.push(cur,cidx[x][y][z-1]);
      }
      if (cidx[x+1] && cidx[x+1][y]) {
        if (z in cidx[x+1][y]) {
          indices.push(cur,cidx[x+1][y][z]);
        }
      }
      if (cidx[x-1] && cidx[x-1][y]) {
        if (z in cidx[x-1][y]) {
          indices.push(cur,cidx[x-1][y][z]);
        }
      }
      if (cidx[x][y+1]) {
        if (z in cidx[x][y+1]) {
          indices.push(cur,cidx[x][y+1][z]);
        }
      }
      if (cidx[x][y-1]) {
        if (z in cidx[x][y-1]) {
          indices.push(cur,cidx[x][y-1][z]);
        }
      }
    });

    var widx = {};
    var wpos = [];
    var windices = [];
    var wp = 0;

    $.each(data['Worldchunks'],function(i,c){
      var x = c[0];
      var y = 0;
      var z = c[1];
      if (!widx[x]) {
        widx[x] = {};
      }
      if (!widx[x][y]) {
        widx[x][y] = {};
      }
      var cur = wp++;
      widx[x][y][z] = cur;
      wpos.push(x);
      wpos.push(y);
      wpos.push(z);
      if (z+1 in widx[x][y]) {
        windices.push(cur,widx[x][y][z+1]);
      }
      if (z-1 in widx[x][y]) {
        windices.push(cur,widx[x][y][z-1]);
      }
      if (widx[x+1] && widx[x+1][y]) {
        if (z in widx[x+1][y]) {
          windices.push(cur,widx[x+1][y][z]);
        }
      }
      if (widx[x-1] && widx[x-1][y]) {
        if (z in widx[x-1][y]) {
          windices.push(cur,widx[x-1][y][z]);
        }
      }
    });

    SceneJS.setConfigs({
      pluginPath: "scenejs"
    });

    scene = SceneJS.createScene({
      transparent: true,
      nodes: [{
        id: "cam",
        type: "cameras/pickFlyOrbit",
        //showCursor: true,
        yaw: 90,
        pitch: -45,
        zoom: 75,
        zoomSensitivity: 20.0,
        nodes: [{
          type: "material",
          color: { r:1, g:0, b:0 },
          nodes: [{
            id: "chunks",
            type: "geometry",
            primitive: "lines",
            positions: pos,
            indices: indices
          }]
        },{
          type: "material",
          color: { r:0, g:1, b:0 },
          nodes: [{
            id: "Worldchunks",
            type: "geometry",
            primitive: "lines",
            positions: wpos,
            indices: windices
          }]
        },{
            id: "attachme"
        }
        ]

      }]

    });
  });
}

update_scene();
</script>
</body>
</html>
